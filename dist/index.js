import*as p from"@actions/core";import k from"fs";import P from"path";var a=i=>{try{return k.existsSync(i)}catch{return!1}},f=i=>{try{return k.readFileSync(i,"utf8")}catch{return null}},y=i=>{try{return k.readdirSync(i)}catch{return[]}},n=P.join;import O from"js-yaml";function x(i){let t=O.load(i);return!t||typeof t!="object"?{}:t}var b=class{static read(t){let o=n(t,".iupipes.yml"),u=f(o);return u?x(u):{}}};var j=class{static detect(t,o){let u=[n(t,o),t];for(let r of u){if(a(n(r,"go.mod")))return"go";if(a(n(r,"package.json")))return"node";if(a(n(r,"pom.xml"))||a(n(r,"build.gradle"))||a(n(r,"build.gradle.kts"))||a(n(r,"settings.gradle"))||a(n(r,"settings.gradle.kts")))return"java";if(a(n(r,"pyproject.toml"))||a(n(r,"requirements.txt"))||y(r).some(l=>/^requirements.*\.txt$/i.test(l))||a(n(r,"setup.py"))||a(n(r,"Pipfile")))return"python"}throw new Error("Unable to detect runtime. Add project.runtime in .iupipes.yml or add a recognizable config file.")}};var h=class{static resolve(t){let{workspace:o,workingDirectory:u,runtime:r}=t,c=n(o,u),l=e=>f(n(c,e))??f(n(o,e));if(r==="node"){let e=l(".nvmrc");if(e){let m=e.trim().replace(/^v/i,"").replace(/\.x$/i,"");if(m)return m}let s=l("package.json");if(s)try{let g=JSON.parse(s)?.engines?.node;if(typeof g=="string"){let d=g.match(/(\d{2})/);if(d)return d[1]}}catch{}return"20"}if(r==="go"){let e=l("go.mod");if(e){let s=e.match(/^\s*go\s+(\d+\.\d+)\s*$/m);if(s)return s[1]}return"1.22"}if(r==="python"){let e=l(".python-version");return e&&e.trim()?e.trim():"3.11"}return"17"}static normalize(t){return t.trim().replace(/^v/i,"").replace(/\.x$/i,"")}};var v=class{static build(t){let{workspace:o,workingDirectory:u,runtime:r,runtimeVersion:c,goal:l,project:e}=t,s=this.buildPhases({workspace:o,workingDirectory:u,runtime:r,goal:l}),m={version:1,detected:{runtime:r,runtimeVersion:c,workingDirectory:u,goal:l},project:e,phases:s,artifacts:this.defaultArtifacts(r)},g={include:[{step_name:"PRE-INSTALL",stage:"pre_install",run:s.pre_install.join(`
`)},{step_name:"INSTALL",stage:"install",run:s.install.join(`
`)},{step_name:"PRE-BUILD",stage:"pre_build",run:s.pre_build.join(`
`)},{step_name:"BUILD",stage:"build",run:s.build.join(`
`)},{step_name:"TEST",stage:"test",run:s.test.join(`
`)},{step_name:"POST",stage:"post",run:s.post.join(`
`)},{step_name:"PUBLISH",stage:"publish",run:s.publish.join(`
`)}]};return{plan:m,matrix:g}}static buildPhases(t){let{workspace:o,workingDirectory:u,runtime:r,goal:c}=t,l=n(o,u),e={pre_install:[],install:[],pre_build:[],build:[],test:[],post:[],publish:[]};if(r==="node"){let m=a(n(l,"package-lock.json"))||a(n(o,"package-lock.json"));return e.pre_install.push('echo "NODE_OPTIONS=--max-old-space-size=4096" >> $GITHUB_ENV'),e.install.push(m?"npm ci":"npm install"),e.test.push("npm test --if-present"),e.build.push("npm run build --if-present"),e}if(r==="python"){let m=[l,o],g=null;for(let d of m){let w=y(d).find(_=>/^requirements.*\.txt$/i.test(_));if(w){g=w;break}if(a(n(d,"requirements.txt"))){g="requirements.txt";break}}return g&&e.install.push(`python -m pip install -r ${g}`),e.test.push("pytest -q"),e}if(r==="go")return e.test.push("go test ./..."),c!=="pr-check"&&e.build.push("go build ./..."),e;let s=this.detectJavaTool(o,u);return s==="maven"?(e.test.push("mvn -B test"),e.build.push("mvn -B -DskipTests package")):s==="gradle-wrapper"?(e.test.push("./gradlew test"),e.build.push("./gradlew build -x test")):(e.test.push("gradle test"),e.build.push("gradle build -x test")),e}static detectJavaTool(t,o){let r=[n(t,o),t];for(let c of r){if(a(n(c,"pom.xml")))return"maven";if(a(n(c,"build.gradle"))||a(n(c,"build.gradle.kts")))return a(n(c,"gradlew"))?"gradle-wrapper":"gradle"}return"maven"}static defaultArtifacts(t){return t==="node"?["dist/**","coverage/**"]:t==="python"?["coverage/**","test-results/**"]:t==="go"?["coverage/**"]:["target/**","build/**","**/surefire-reports/**","**/test-results/**"]}};function R(i){let o=(i??".").trim().replace(/\\/g,"/").replace(/\/+$/g,"");return o.length?o:"."}function D(i){let t=(i??"ci").toLowerCase().trim();return t==="pr-check"||t==="ci"||t==="release"?t:"ci"}function S(i){let t=(i??"auto").toLowerCase().trim();return t==="auto"?"auto":t==="node"||t==="java"||t==="python"||t==="go"?t:"auto"}async function T(){try{let i=process.env.GITHUB_WORKSPACE??process.cwd(),o=b.read(i).project??{},u=R(o["working-directory"]),r=D(o.goal),c=S(o.runtime);c==="auto"&&(c=j.detect(i,u));let l=(o["runtime-version"]??"auto").toString().trim().toLowerCase(),e=l==="auto"||l===""?h.resolve({workspace:i,workingDirectory:u,runtime:c}):h.normalize(l),{plan:s,matrix:m}=v.build({workspace:i,workingDirectory:u,runtime:c,runtimeVersion:e,goal:r,project:o});p.setOutput("runtime",c),p.setOutput("runtime_version",e),p.setOutput("working_directory",u),p.setOutput("plan_json",JSON.stringify(s)),p.setOutput("matrix",JSON.stringify(m)),p.setOutput("cmd_pre_install",s.phases.pre_install.join(`
`)),p.setOutput("cmd_install",s.phases.install.join(`
`)),p.setOutput("cmd_pre_build",s.phases.pre_build.join(`
`)),p.setOutput("cmd_build",s.phases.build.join(`
`)),p.setOutput("cmd_test",s.phases.test.join(`
`)),p.setOutput("cmd_post",s.phases.post.join(`
`)),p.info(`runtime=${c}`),p.info(`runtime_version=${e}`),p.info(`working_directory=${u}`),p.info(`goal=${r}`)}catch(i){p.setFailed(i?.message??String(i))}}T();
//# sourceMappingURL=index.js.map